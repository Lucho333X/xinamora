<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XINA MORA | LA SEÑAL | MASTER V9</title>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700;800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-color: #050505;
            --text-color: #f0f0f0;
            --accent-color: #ff3333; /* Rojo XINA Original */
            --secondary-accent: #33ff33;
            --grid-line: #222;
            --font-head: 'Space Grotesk', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --cursor-size: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; cursor: none; }

        html { scroll-behavior: smooth; }

        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: var(--font-head); overflow-x: hidden; text-transform: uppercase;
        }

        /* --- CUSTOM CURSOR --- */
        #cursor {
            position: fixed; top: 0; left: 0; width: var(--cursor-size); height: var(--cursor-size);
            border: 2px solid var(--accent-color); transform: translate(-50%, -50%) rotate(45deg);
            pointer-events: none; z-index: 9999; transition: width 0.1s, height 0.1s;
            mix-blend-mode: difference;
        }
        #cursor.active { background: var(--accent-color); width: 10px; height: 10px; }
        
        /* --- BACKGROUND FX --- */
        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYV/hXchAAAAHXRSTlMA+++++++++g+++++++O++++++f++++++U+++++f62T+fAAAAHlJREFUeNrtwQEBAAAAgqD+r2zHBxQAAAAAAAAAAAAAAIB3BuG1AAG35GzgAAAAAElFTkSuQmCC') repeat;
            opacity: 0.05; z-index: 900;
        }

        /* --- TICKER --- */
        .ticker-wrap {
            width: 100%; overflow: hidden; background-color: var(--accent-color);
            color: #000; border-bottom: 1px solid var(--grid-line);
        }
        .ticker {
            display: inline-block; white-space: nowrap; padding: 10px 0;
            animation: ticker 15s linear infinite; font-family: var(--font-mono);
            font-weight: 700; font-size: 1.2rem;
        }
        .ticker__item { padding: 0 2rem; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 40px; border-bottom: 1px solid var(--grid-line);
            position: sticky; top: 0; background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(5px); z-index: 100;
        }
        .logo-container img { 
            height: 40px; /* Altura ajustada para el header */
            width: auto; 
            display: block;
        }
        .nav-links { display: flex; gap: 40px; font-family: var(--font-mono); font-size: 0.85rem; }
        .nav-links li { transition: 0.2s; }
        .nav-links li:hover { color: var(--accent-color); text-shadow: 2px 0 var(--secondary-accent); }

        /* --- CONTROLS --- */
        .controls-panel {
            position: fixed; bottom: 30px; right: 30px; z-index: 800;
            display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
        }
        .control-btn {
            background: rgba(0,0,0,0.9); border: 1px solid #333; color: #fff;
            padding: 10px 15px; font-family: var(--font-mono); font-size: 0.8rem;
            transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .control-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .audio-group { display: flex; gap: 5px; background: #000; padding: 5px; border: 1px solid #333; }
        .active-music { background-color: var(--accent-color) !important; color: #000 !important; border-color: var(--accent-color) !important; }

        /* --- HERO --- */
        .hero { padding: 80px 40px; border-bottom: 1px solid var(--grid-line); position: relative; }
        .hero h1 {
            font-size: clamp(3rem, 8vw, 8rem); line-height: 0.85; font-weight: 800;
            letter-spacing: -3px; margin-bottom: 30px;
        }
        .glitch-text { display: inline-block; transition: 0.3s; }
        .hero:hover .glitch-text { color: var(--accent-color); transform: skewX(-10deg); }

        .cta-btn {
            padding: 15px 40px; background: transparent; border: 2px solid var(--text-color);
            color: var(--text-color); font-family: var(--font-mono); font-weight: 700;
            font-size: 1rem; position: relative; overflow: hidden; transition: 0.3s; margin-top: 20px;
        }
        .cta-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: var(--accent-color); transition: 0.4s; z-index: -1;
        }
        .cta-btn:hover::before { left: 0; }
        .cta-btn:hover { border-color: var(--accent-color); color: black; box-shadow: 0 0 20px var(--accent-color); }
        .cta-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- EVENTS --- */
        .events-container { border-bottom: 1px solid var(--grid-line); scroll-margin-top: 80px; }
        .filter-bar {
            display: flex; gap: 20px; padding: 20px 40px; border-bottom: 1px solid var(--grid-line);
            font-family: var(--font-mono); font-size: 0.9rem; overflow-x: auto; position: sticky; top: 80px; background: var(--bg-color); z-index: 90;
        }
        .filter-btn { opacity: 0.5; transition: 0.3s; cursor: none; }
        .filter-btn.active, .filter-btn:hover { opacity: 1; color: var(--accent-color); text-decoration: underline; }

        .event-row {
            display: grid; grid-template-columns: 1fr 3fr 1fr; padding: 25px 40px;
            border-bottom: 1px solid #1a1a1a; align-items: center; transition: 0.2s;
            scroll-margin-top: 140px; 
        }
        .event-row:hover { background: var(--text-color); color: var(--bg-color); }
        .event-row:hover .date { color: var(--bg-color); }
        .date { font-family: var(--font-mono); color: var(--accent-color); font-weight: 700; font-size: 1.5rem; }
        .ticket-tag { border: 1px solid currentColor; padding: 5px 15px; font-family: var(--font-mono); font-size: 0.8rem; }

        /* --- BIG LOGO SECTION --- */
        .big-logo-section {
            padding: 60px 0; 
            border-bottom: 1px solid var(--grid-line);
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        .big-logo-section a {
            display: block; 
            width: 100%;
            text-align: center;
        }
        .big-logo-section img {
            max-width: 100%; 
            width: 900px; 
            height: auto;
            filter: none; 
            transition: 0.3s;
        }
        .big-logo-section img:hover {
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1));
            transform: scale(1.01);
        }

        /* --- FOOTER --- */
        footer {
            padding: 80px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: var(--font-mono);
            color: #666;
            font-size: 0.8rem;
            gap: 30px;
            text-align: center;
        }
        .footer-text { display: flex; flex-direction: column; gap: 10px; }
        .social-links { display: flex; gap: 30px; font-size: 1.8rem; }
        .social-links a { color: var(--accent-color); transition: 0.3s; }
        .social-links a:hover { color: #fff; text-shadow: 0 0 15px var(--accent-color); transform: scale(1.1); }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 9998; justify-content: center;
            align-items: center; flex-direction: column;
        }
        
        .newsletter-box {
            border: 2px solid var(--text-color); background: #000; padding: 40px;
            max-width: 500px; width: 90%; text-align: center; position: relative;
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.1);
            pointer-events: auto; 
        }
        .newsletter-input {
            width: 100%; padding: 15px; background: #111; border: 1px solid #333;
            color: white; font-family: var(--font-mono); margin: 20px 0; text-align: center;
        }
        .newsletter-input:focus { border-color: var(--accent-color); outline: none; }

        /* Game UI */
        .game-wrapper {
            position: relative; border: 2px solid var(--accent-color);
            box-shadow: 0 0 50px rgba(255, 51, 51, 0.15);
        }
        canvas { display: block; background: #050505; cursor: crosshair; }
        
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .mode-select { 
            pointer-events: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;
            background: rgba(5,5,5,0.98); padding: 60px; border: 1px solid #333;
            backdrop-filter: blur(10px); max-width: 800px; width: 95%;
        }
        .mode-card {
            border: 1px solid #333; padding: 30px; text-align: center; transition: 0.3s;
            cursor: none; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 220px; background: #080808;
        }
        .mode-card:hover {
            background: #111; transform: scale(1.05); border-color: var(--accent-color);
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.2);
        }
        .mode-card h3 { font-size: 1.5rem; margin-bottom: 10px; color: var(--accent-color); }
        .mode-card p { font-family: var(--font-mono); font-size: 0.8rem; color: #aaa; }
        
        .close-modal { position: absolute; top: -40px; right: 0; font-family: var(--font-mono); color: #fff; cursor: none; font-size: 1rem; }
        .close-modal:hover { color: var(--accent-color); }
        
        .in-game-mute {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            background: #333; border: 1px solid #555; color: #888;
            padding: 8px 15px; font-family: var(--font-mono); font-size: 0.8rem;
            z-index: 10002; transition: 0.3s;
        }
        .in-game-mute.active {
            background: var(--accent-color); border-color: var(--accent-color); color: #000; font-weight: bold;
        }

        #scoreHud {
            position: absolute; top: 20px; left: 20px; font-family: var(--font-mono);
            color: white; font-size: 1.2rem; display: none; text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        @media(max-width: 768px) {
            .mode-select { grid-template-columns: 1fr; padding: 20px; }
            .hero h1 { font-size: 3.5rem; }
            .nav-links { display: none; }
            .controls-panel { bottom: 10px; right: 10px; }
            .game-wrapper canvas { width: 100%; height: auto; }
        }
    </style>
</head>
<body>

    <div id="cursor"></div>
    <div class="noise-overlay"></div>

    <!-- CONTROLES -->
    <div class="controls-panel">
        <div class="audio-group">
            <button class="control-btn hover-target" onclick="toggleMusic()" id="playBtn">
                <i class="fas fa-play"></i>
            </button>
            <button class="control-btn hover-target" onclick="changeTrack()">
                <i class="fas fa-forward"></i>
            </button>
            <div class="control-btn" style="border:none; color:#888;" id="trackDisplay">TRACK 1</div>
        </div>
    </div>

    <!-- MARQUESINA -->
    <div class="ticker-wrap">
        <div class="ticker">
            <span class="ticker__item">LA SEÑAL LLEGA A LATAM</span>
            <span class="ticker__item">COLOMBIA • MÉXICO • ARGENTINA • CHILE</span>
            <span class="ticker__item">/// XINA MORA LIVE</span>
            <span class="ticker__item">INDUSTRIAL TECHNO EXPERIENCE</span>
            <span class="ticker__item">GET YOUR TICKETS NOW</span>
        </div>
    </div>

    <header>
        <div class="logo-container hover-target">
            <!-- LOGO IMAGEN (Requiere subir logo.png) -->
            <img src="logo.png" alt="XINA MORA LOGO" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <!-- Fallback texto por si no hay imagen -->
            <h2 style="font-weight:800; letter-spacing:-1px; display:none;">XINA MORA</h2>
        </div>
        <ul class="nav-links">
            <li class="hover-target" onclick="document.querySelector('.events-container').scrollIntoView({behavior: 'smooth'})">TOUR</li>
            <li class="hover-target" onclick="window.open('https://open.spotify.com/intl-es/artist/4dRPdWRUFyJp0yhjGBLClx', '_blank')">MÚSICA</li>
            <li class="hover-target" onclick="openGame()">JUEGO</li>
            <li class="hover-target" onclick="window.open('https://shop.xinamora.com', '_blank')">MERCH</li>
        </ul>
    </header>

    <section class="hero">
        <h1>
            <span class="glitch-text">LA SEÑAL</span><br>
            LLEGA A <span style="color:var(--accent-color)">LATAM</span>
        </h1>
        <p style="font-family: var(--font-mono); max-width: 500px; margin-bottom: 30px;">
            EL TOUR TECHNO MÁS ESPERADO. RECIBE LA SEÑAL.
        </p>
        <button class="cta-btn hover-target" onclick="openGame()">
            [ INICIAR MISIÓN: JUGAR PARA GANAR ]
        </button>
    </section>

    <section class="events-container">
        <div class="filter-bar">
            <span class="filter-btn active hover-target" onclick="scrollToEvent('all')">TODAS LAS FECHAS</span>
            <span class="filter-btn hover-target" onclick="scrollToEvent('col')">COLOMBIA</span>
            <span class="filter-btn hover-target" onclick="scrollToEvent('mex')">MÉXICO</span>
            <span class="filter-btn hover-target" onclick="scrollToEvent('arg')">ARGENTINA</span>
            <span class="filter-btn hover-target" onclick="scrollToEvent('chi')">CHILE</span>
        </div>

        <div class="event-row hover-target" id="event-col">
            <div class="date">28.11</div>
            <div class="details">
                <h3>BOGOTÁ</h3>
                <p>GATE CLUB // COLOMBIA</p>
            </div>
            <div class="action"><span class="ticket-tag">TICKETS</span></div>
        </div>
        <div class="event-row hover-target" id="event-mex">
            <div class="date">29.11</div>
            <div class="details">
                <h3>CDMX</h3>
                <p>TBA // MÉXICO</p>
            </div>
            <div class="action"><span class="ticket-tag">TICKETS</span></div>
        </div>
        <div class="event-row hover-target" id="event-arg">
            <div class="date">05.12</div>
            <div class="details">
                <h3>BUENOS AIRES</h3>
                <p>TBA // ARGENTINA</p>
            </div>
            <div class="action"><span class="ticket-tag">TICKETS</span></div>
        </div>
        <div class="event-row hover-target" id="event-chi">
            <div class="date">07.12</div>
            <div class="details">
                <h3>SANTIAGO</h3>
                <p>TBA // CHILE</p>
            </div>
            <div class="action"><span class="ticket-tag">TICKETS</span></div>
        </div>
    </section>

    <!-- SECCIÓN: LOGO GRANDE (100% ANCHO Y CON ENLACE) -->
    <div class="big-logo-section hover-target">
        <a href="https://www.xinamora.com" target="_blank" class="hover-target">
            <img src="logo.png" alt="XINA MORA LARGE LOGO" onerror="this.style.display='none'">
        </a>
    </div>

    <footer>
        <div class="footer-text">
            <span>© 2025 XINA MORA ENTERTAINMENT</span>
            <span>DISEÑADO PARA EL UNDERGROUND</span>
        </div>
        <div class="social-links">
            <a href="https://www.instagram.com/laxinamora/?hl=es" target="_blank" class="hover-target"><i class="fab fa-instagram"></i></a>
            <a href="https://www.tiktok.com/@laxinamora?lang=es" target="_blank" class="hover-target"><i class="fab fa-tiktok"></i></a>
            <a href="https://www.youtube.com/@XinaMora" target="_blank" class="hover-target"><i class="fab fa-youtube"></i></a>
            <a href="https://open.spotify.com/intl-es/artist/4dRPdWRUFyJp0yhjGBLClx" target="_blank" class="hover-target"><i class="fab fa-spotify"></i></a>
        </div>
    </footer>

    <!-- MODAL NEWSLETTER INICIAL (ACTUALIZADO CON FORMSPREE) -->
    <div id="newsletterModal" class="modal-overlay">
        <div class="newsletter-box">
            <div class="close-modal hover-target" onclick="closeNewsletter()" style="top:10px; right:20px; font-size:1.5rem;">✕</div>
            <h2>RECIBE LA SEÑAL</h2>
            <p style="margin-top:10px; font-family:var(--font-mono); color:#888;">INFO EXCLUSIVA DEL TOUR.</p>
            
            <form id="newsletterForm" action="https://formspree.io/f/mnnrbgwb" method="POST">
                <input type="email" name="_replyto" class="newsletter-input hover-target" placeholder="EMAIL_ADDRESS" required>
                <input type="hidden" name="Subject" value="Suscripción XINA MORA Newsletter">
                <button type="submit" id="newsletterBtn" class="cta-btn hover-target">SUSCRIBIRSE</button>
            </form>
            <p id="newsletterStatus" style="font-family: var(--font-mono); font-size: 0.8rem; color: #fff; margin-top: 10px; min-height: 1.2em;"></p>

        </div>
    </div>

    <!-- MODAL JUEGO -->
    <div id="gameModal" class="modal-overlay">
        
        <div class="game-wrapper">
            <div class="close-modal hover-target" onclick="closeGame()">✕ SALIR</div>
            
            <button class="in-game-mute hover-target" onclick="toggleMusic()" id="inGameMuteBtn">
                <i class="fas fa-volume-mute"></i> MUSIC: OFF
            </button>

            <canvas id="gameCanvas" width="800" height="500"></canvas>
            
            <div id="scoreHud"></div>

            <div id="uiLayer" class="ui-layer">
                <!-- Selección -->
                <div id="modeSelect" class="mode-select">
                    <div style="grid-column: span 2; text-align: center; margin-bottom: 10px;">
                        <h2>SELECCIONA TU MISIÓN</h2>
                    </div>
                    
                    <div class="mode-card hover-target" onclick="selectMode('SPACESHIP')">
                        <i class="fas fa-shuttle-space" style="font-size: 3rem; margin-bottom: 20px; color: #fff;"></i>
                        <h3>SPACESHIP HARD TECHNO</h3>
                        <p>CONTROLES: FLECHAS + ESPACIO</p>
                        <div style="color: var(--accent-color);">[ START ]</div>
                    </div>

                    <div class="mode-card hover-target" onclick="selectMode('ZOMBIES')">
                        <i class="fas fa-biohazard" style="font-size: 3rem; margin-bottom: 20px; color: #fff;"></i>
                        <h3>TECHNO ZOMBIES</h3>
                        <p>CONTROLES: RATÓN + CLICK/ESPACIO</p>
                        <div style="color: var(--secondary-accent);">[ START ]</div>
                    </div>
                </div>

                <!-- Game Over (ACTUALIZADO CON FORMSPREE) -->
                <div id="gameOverScreen" class="newsletter-box" style="display:none; border-color:var(--accent-color);">
                    <h2 style="color: var(--accent-color); text-shadow: 0 0 10px red;">HAS MUERTO</h2>
                    <p style="margin: 10px 0; font-family: var(--font-mono);">LA SEÑAL SE HA PERDIDO.</p>
                    <p style="font-size: 0.8rem; color:#666; margin-bottom: 20px;">ENVÍA INFORME DE ERROR PARA SALIR.</p>
                    
                    <form id="exitForm" action="https://formspree.io/f/mnnrbgwb" method="POST">
                        <input type="email" id="exitEmail" name="_replyto" class="newsletter-input hover-target" placeholder="TU_EMAIL" required>
                        <input type="hidden" name="Subject" value="Informe de Error XINA MORA - Juego">
                        <input type="hidden" name="Game_Score" id="hiddenScoreInput">
                        <button type="submit" id="sendExitBtn" class="cta-btn hover-target">ENVIAR LA SEÑAL</button>
                    </form>

                    <p id="exitStatus" style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--secondary-accent); margin-top: 10px; min-height: 1.2em;"></p>
                    
                    <div style="margin-top: 20px;">
                        <span class="hover-target" onclick="showModeSelect()" style="font-size: 0.8rem; text-decoration: underline; cursor: none; color: #fff;">REINTENTAR MISIÓN</span>
                    </div>
                </div>

                <!-- Win Screen -->
                <div id="winScreen" class="newsletter-box" style="display:none; border-color:var(--secondary-accent);">
                    <h2 style="color:var(--secondary-accent);">OBJETIVO CUMPLIDO</h2>
                    <div style="font-size: 2rem; border: 1px dashed var(--secondary-accent); margin: 20px 0; padding: 10px; color: #fff;">CODE: SIGNAL999</div>
                    <button class="cta-btn hover-target" onclick="closeGame()">RECLAMAR</button>
                </div>
            </div>
        </div>
        <div style="margin-top: 15px; font-family: var(--font-mono); color: #666; font-size: 0.8rem;" id="controlsText">
            /// SYSTEM READY
        </div>
    </div>

    <script>
        // Formspree URL para ambos formularios (Newsletter y Game Over)
        const formspreeUrl = 'https://formspree.io/f/mnnrbgwb';

        // --- NAVIGATION LOGIC ---
        function scrollToEvent(id) {
            if(id === 'all') {
                window.scrollTo({top: 0, behavior: 'smooth'});
            } else {
                const el = document.getElementById('event-' + id);
                if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        }

        // --- AUDIO SYNTHESIZER (SFX) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, type, duration, vol = 0.1) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            if(type === 'sawtooth') {
                osc.frequency.exponentialRampToValueAtTime(freq * 0.1, audioCtx.currentTime + duration);
            }
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function sfxShoot() { playTone(800, 'sawtooth', 0.15, 0.1); }
        function sfxExplosion() { playTone(100, 'square', 0.3, 0.2); playTone(50, 'sawtooth', 0.4, 0.2); }
        function sfxZombieHit() { playTone(200, 'square', 0.1, 0.05); }

        // --- MÚSICA ---
        const tracks = [
            { name: "TRACK 1", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }
        ];
        let audio = new Audio(tracks[0].src);
        audio.volume = 0.6;
        audio.loop = true;

        function updateMusicUI(isPlaying) {
            const mainBtn = document.getElementById('playBtn');
            const gameBtn = document.getElementById('inGameMuteBtn');
            
            if(isPlaying) {
                mainBtn.classList.add('active-music');
                mainBtn.innerHTML = '<i class="fas fa-pause"></i>';
                gameBtn.classList.add('active');
                gameBtn.innerHTML = '<i class="fas fa-volume-up"></i> MUSIC: ON';
            } else {
                mainBtn.classList.remove('active-music');
                mainBtn.innerHTML = '<i class="fas fa-play"></i>';
                gameBtn.classList.remove('active');
                gameBtn.innerHTML = '<i class="fas fa-volume-mute"></i> MUSIC: OFF';
            }
        }

        function toggleMusic() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if(audio.paused) { audio.play(); updateMusicUI(true); } 
            else { audio.pause(); updateMusicUI(false); }
        }

        function changeTrack() {
            audio.currentTime = 0;
            if(audio.paused) toggleMusic();
        }

        // --- MANEJO DE FORMULARIOS REALES CON FETCH (FORM SPREE) ---

        // Función para manejar el envío real del formulario del Game Over
        async function handleExitFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('sendExitBtn');
            const status = document.getElementById('exitStatus');
            
            // 1. Recoger Score y Wave
            document.getElementById('hiddenScoreInput').value = `Score: ${score} - Wave: ${wave}`;

            btn.disabled = true;
            btn.innerText = "CONECTANDO...";
            status.innerHTML = `ENVIANDO INFORME...`;
            status.style.color = "#33ff33";

            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    body: new FormData(form),
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    status.innerHTML = "SEÑAL VERIFICADA: Informe enviado con éxito.";
                    status.style.color = "#33ff33";
                    
                    setTimeout(() => {
                        closeGame();
                        // Limpiar y resetear el formulario al cerrar el modal
                        form.reset();
                        status.innerHTML = "";
                    }, 2000);
                } else {
                    status.innerHTML = "ERROR: El servidor de señales falló. Intenta de nuevo.";
                    status.style.color = "red";
                }
            } catch (error) {
                console.error('Error de red al enviar el formulario:', error);
                status.innerHTML = "ERROR DE CONEXIÓN. Revisa tu conexión a internet.";
                status.style.color = "red";
            } finally {
                btn.disabled = false;
                btn.innerText = "ENVIAR LA SEÑAL";
            }
        }

        // Función para manejar el envío del formulario de la Newsletter
        async function handleNewsletterSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('newsletterBtn');
            const status = document.getElementById('newsletterStatus');

            btn.disabled = true;
            btn.innerText = "VERIFICANDO...";
            status.innerHTML = "";
            
            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    body: new FormData(form),
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    status.innerHTML = "¡GRACIAS! Ya estás en la lista.";
                    status.style.color = "#33ff33";
                    
                    setTimeout(() => {
                        closeNewsletter();
                        form.reset();
                        status.innerHTML = "";
                    }, 2000);
                } else {
                    status.innerHTML = "ERROR: No pudimos procesar la suscripción.";
                    status.style.color = "red";
                }
            } catch (error) {
                console.error('Error de red al suscribirse:', error);
                status.innerHTML = "ERROR DE CONEXIÓN.";
                status.style.color = "red";
            } finally {
                btn.disabled = false;
                btn.innerText = "SUSCRIBIRSE";
            }
        }


        // --- GENERAL UI ---
        setTimeout(() => { document.getElementById('newsletterModal').style.display = 'flex'; }, 15000);
        function closeNewsletter() { document.getElementById('newsletterModal').style.display = 'none'; }

        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => {
            cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
        });
        document.querySelectorAll('.hover-target').forEach(el => {
            el.addEventListener('mouseenter', () => {
                cursor.classList.add('active');
                document.body.style.cursor = 'none';
            });
            el.addEventListener('mouseleave', () => cursor.classList.remove('active'));
        });

        window.addEventListener('load', () => {
            // Asigna los listeners de envío
            const exitForm = document.getElementById('exitForm');
            const newsletterForm = document.getElementById('newsletterForm');
            
            if (exitForm) {
                exitForm.addEventListener('submit', handleExitFormSubmit);
            }
            if (newsletterForm) {
                newsletterForm.addEventListener('submit', handleNewsletterSubmit);
            }
        });


        // ==========================================
        // === GAME ENGINE V7 (LOGIC PRESERVED) ===
        // ==========================================
        const modal = document.getElementById('gameModal');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameLoopId;
        let gameActive = false;
        let mode = null;
        
        let score = 0;
        let displayScore = 0;
        let frame = 0;
        let shake = 0;
        let wave = 111;

        const keys = {};
        const mouse = { x: 400, y: 250, down: false };

        document.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='Space'||e.code.startsWith('Arrow')) e.preventDefault(); });
        document.addEventListener('keyup', e => keys[e.code] = false);
        
        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            mouse.x = (e.clientX - rect.left) * scaleX;
            mouse.y = (e.clientY - rect.top) * scaleY;
        });
        canvas.addEventListener('mousedown', () => mouse.down = true);
        canvas.addEventListener('mouseup', () => mouse.down = false);

        let player = {};
        let bullets = [];
        let enemies = [];
        let particles = [];
        let stars = [];
        let zombiesToSpawn = 0;

        function openGame() {
            modal.style.display = 'flex';
            showModeSelect();
        }
        function closeGame() {
            modal.style.display = 'none';
            gameActive = false;
            cancelAnimationFrame(gameLoopId);
        }

        function showModeSelect() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            document.getElementById('modeSelect').style.display = 'grid';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('winScreen').style.display = 'none';
            document.getElementById('scoreHud').style.display = 'none';
            document.getElementById('controlsText').innerText = "/// SYSTEM READY";
        }

        function selectMode(selectedMode) {
            mode = selectedMode;
            startGame();
        }

        function startGame() {
            document.getElementById('modeSelect').style.display = 'none';
            document.getElementById('scoreHud').style.display = 'block';
            
            gameActive = true;
            score = 0; displayScore = 0;
            bullets = []; enemies = []; particles = []; frame = 0;
            
            if(mode === 'SPACESHIP') {
                initSpaceship();
                document.getElementById('controlsText').innerText = "PILOTA CON FLECHAS • DISPARA CON ESPACIO";
            } else {
                initZombies();
                document.getElementById('controlsText').innerText = "MUEVE CON RATÓN • DISPARA CON CLICK/ESPACIO";
            }

            if(audio.paused) toggleMusic();
            loop();
        }

        function loop() {
            if(!gameActive) return;
            frame++;
            
            if(shake > 0) shake *= 0.9;
            let dx = (Math.random()-0.5)*shake;
            let dy = (Math.random()-0.5)*shake;

            if(displayScore < score) displayScore += Math.ceil((score - displayScore)*0.2);

            ctx.save();
            ctx.translate(dx, dy);

            if(mode === 'SPACESHIP') updateSpaceship();
            else updateZombies();

            ctx.restore();

            let hpColor = player.hp > 50 ? '#fff' : '#ff0000';
            let waveText = mode === 'ZOMBIES' ? ` | WAVE: ${wave}` : '';
            document.getElementById('scoreHud').innerHTML = `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--accent-color')}">SCORE:</span> ${displayScore} <span style="color:${hpColor}">| HP: ${Math.floor(player.hp)}%</span>${waveText}`;

            gameLoopId = requestAnimationFrame(loop);
        }

        // --- SPACESHIP LOGIC ---
        function initSpaceship() {
            player = { x: 50, y: 250, size: 20, speed: 8, hp: 100, cooldown: 0 };
            stars = [];
            for(let i=0; i<80; i++) stars.push({x:Math.random()*800, y:Math.random()*500, s:Math.random()*3+2});
        }

        function updateSpaceship() {
            if(keys.ArrowUp && player.y > 20) player.y -= player.speed;
            if(keys.ArrowDown && player.y < 480) player.y += player.speed;
            if(keys.ArrowLeft && player.x > 20) player.x -= player.speed;
            if(keys.ArrowRight && player.x < 780) player.x += player.speed;

            if(keys.Space && player.cooldown <= 0) {
                bullets.push({ x: player.x+20, y: player.y, w:30, h:4, color: '#ccff00' });
                player.cooldown = 8;
                sfxShoot();
            }
            if(player.cooldown > 0) player.cooldown--;

            bullets.forEach(b => b.x += 20);
            bullets = bullets.filter(b => b.x < 850);

            if(frame % 30 === 0) {
                enemies.push({ x: 850, y: Math.random()*460+20, size: 25, speed: 5+(score/2000) });
            }
            enemies.forEach(e => { e.x -= e.speed; });

            enemies.forEach((e, ei) => {
                if(Math.hypot(player.x - e.x, player.y - e.y) < player.size + e.size) {
                    player.hp -= 20; shake = 15; sfxExplosion();
                    enemies.splice(ei, 1);
                    createParticles(player.x, player.y, '#ff0000', 20);
                }
                bullets.forEach((b, bi) => {
                    if(Math.hypot(b.x - e.x, b.y - e.y) < e.size + 10) {
                        enemies.splice(ei, 1); bullets.splice(bi, 1);
                        score += 100; sfxExplosion();
                        createParticles(e.x, e.y, '#ccff00', 10);
                    }
                });
            });
            enemies = enemies.filter(e => e.x > -50);
            if(player.hp <= 0) gameOver();

            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,800,500);
            ctx.fillStyle = '#444';
            stars.forEach(s => {
                s.x -= s.s * 2; if(s.x<0) s.x=800;
                ctx.fillRect(s.x, s.y, s.s*3, 2);
            });

            ctx.translate(player.x, player.y);
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.moveTo(25,0); ctx.lineTo(-15,15); ctx.lineTo(-10,0); ctx.lineTo(-15,-15); ctx.fill();
            ctx.fillStyle = `rgba(255, 50, 50, ${Math.random()})`;
            ctx.beginPath(); ctx.moveTo(-15, 5); ctx.lineTo(-35 - Math.random()*10, 0); ctx.lineTo(-15, -5); ctx.fill();
            ctx.translate(-player.x, -player.y);

            enemies.forEach(e => {
                ctx.fillStyle = '#ff0000';
                ctx.beginPath(); ctx.moveTo(e.x-e.size, e.y); ctx.lineTo(e.x+e.size, e.y-10); ctx.lineTo(e.x+e.size, e.y+10); ctx.fill();
            });

            ctx.fillStyle = '#ccff00';
            bullets.forEach(b => {
                ctx.shadowBlur = 10; ctx.shadowColor = '#ccff00';
                ctx.fillRect(b.x, b.y, b.w, b.h);
                ctx.shadowBlur = 0;
            });
            
            drawParticles();
        }

        // --- ZOMBIE LOGIC ---
        function initZombies() {
            player = { x: 400, y: 250, size: 15, speed: 0.1, hp: 100, cooldown: 0, angle: 0 };
            wave = 111;
            startZombieWave();
        }

        function startZombieWave() {
            zombiesToSpawn = Math.floor(wave / 20) + 3; 
            if(wave >= 999) {
                document.getElementById('winScreen').style.display = 'block';
                gameActive = false;
            }
        }

        function updateZombies() {
            player.x += (mouse.x - player.x) * player.speed;
            player.y += (mouse.y - player.y) * player.speed;
            player.angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);

            if((mouse.down || keys.Space) && player.cooldown <= 0) {
                bullets.push({ 
                    x: player.x, y: player.y, 
                    vx: Math.cos(player.angle) * 15, vy: Math.sin(player.angle) * 15, 
                    life: 50 
                });
                player.cooldown = 10;
                shake = 2;
                sfxShoot();
            }
            if(player.cooldown > 0) player.cooldown--;

            bullets.forEach(b => { b.x += b.vx; b.y += b.vy; b.life--; });
            bullets = bullets.filter(b => b.life > 0);

            if(zombiesToSpawn > 0 && frame % 60 === 0) {
                let a = Math.random() * 6.28;
                let r = 500;
                enemies.push({
                    x: 400 + Math.cos(a)*r, y: 250 + Math.sin(a)*r,
                    speed: 1 + (wave/1000), 
                    hp: 2, size: 15
                });
                zombiesToSpawn--;
            }
            if(zombiesToSpawn === 0 && enemies.length === 0) {
                wave += 111;
                player.hp = Math.min(100, player.hp + 20);
                startZombieWave();
            }

            enemies.forEach((e, ei) => {
                let ang = Math.atan2(player.y - e.y, player.x - e.x);
                e.x += Math.cos(ang) * e.speed;
                e.y += Math.sin(ang) * e.speed;

                if(Math.hypot(player.x - e.x, player.y - e.y) < 25) {
                    player.hp -= 1; shake = 3;
                    if(frame % 10 === 0) createParticles(player.x, player.y, '#ff0000', 2);
                }

                bullets.forEach((b, bi) => {
                    if(Math.hypot(b.x - e.x, b.y - e.y) < 30) {
                        e.hp--;
                        bullets.splice(bi, 1);
                        createParticles(e.x, e.y, '#ccff00', 5);
                        sfxZombieHit();
                        if(e.hp <= 0) {
                            enemies.splice(ei, 1);
                            score += 50;
                            createParticles(e.x, e.y, '#33ff33', 15); 
                            sfxExplosion();
                        }
                    }
                });
            });
            if(player.hp <= 0) gameOver();

            ctx.fillStyle = '#080808'; ctx.fillRect(0,0,800,500);
            ctx.strokeStyle = `rgba(50, 0, 0, ${0.2 + Math.sin(frame*0.1)*0.1})`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            for(let i=0;i<800;i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,500); }
            for(let i=0;i<500;i+=50) { ctx.moveTo(0,i); ctx.lineTo(800,i); }
            ctx.stroke();

            drawParticles();

            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.angle);
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(0,0,12,0,6.28); ctx.fill();
            ctx.fillStyle = '#ccff00'; ctx.fillRect(5, -2, 20, 4);
            ctx.restore();

            enemies.forEach(e => {
                ctx.fillStyle = '#33ff33'; 
                ctx.beginPath(); ctx.arc(e.x, e.y, e.size, 0, Math.PI*2); ctx.fill();
                
                let angle = Math.atan2(player.y - e.y, player.x - e.x);
                ctx.strokeStyle = '#33ff33'; ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(e.x + Math.cos(angle+0.5)*e.size, e.y + Math.sin(angle+0.5)*e.size);
                ctx.lineTo(e.x + Math.cos(angle+0.5)*(e.size+10), e.y + Math.sin(angle+0.5)*(e.size+10));
                ctx.moveTo(e.x + Math.cos(angle-0.5)*e.size, e.y + Math.sin(angle-0.5)*e.size);
                ctx.lineTo(e.x + Math.cos(angle-0.5)*(e.size+10), e.y + Math.sin(angle-0.5)*(e.size+10));
                ctx.stroke();

                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(e.x + Math.cos(angle-0.3)*5, e.y + Math.sin(angle-0.3)*5, 2, 0, Math.PI*2);
                ctx.arc(e.x + Math.cos(angle+0.3)*5, e.y + Math.sin(angle+0.3)*5, 2, 0, Math.PI*2);
                ctx.fill();
            });

            ctx.fillStyle = '#ffff00';
            bullets.forEach(b => {
                ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, 6.28); ctx.fill();
            });
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x, y: y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 40, color: color
                });
            }
        }

        function drawParticles() {
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life--;
                p.vx *= 0.9; p.vy *= 0.9;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 40;
                ctx.fillRect(p.x, p.y, 3, 3);
                if(p.life <= 0) particles.splice(i, 1);
            });
            ctx.globalAlpha = 1;
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('scoreHud').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
        }

    </script>
</body>
</html>
