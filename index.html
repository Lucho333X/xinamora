<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XINA MORA | LA SEÑAL | MASTER V14</title>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700;800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-color: #050505;
            --text-color: #f0f0f0;
            --accent-color: #FF0000; /* Rojo Potente Neon */
            --secondary-accent: #33ff33;
            --grid-line: #222;
            --font-head: 'Space Grotesk', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --cursor-size: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; cursor: none; }

        /* Ajustes Mobile */
        canvas { touch-action: none; user-select: none; -webkit-user-select: none; }
        html { scroll-behavior: smooth; }

        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: var(--font-head); overflow-x: hidden; text-transform: uppercase;
        }

        /* --- ROTATE OVERLAY (Hidden by default, controlled via JS class) --- */
        #rotateOverlay {
            display: none; /* Por defecto oculto */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20000; /* Z-index supremo */
            flex-direction: column; justify-content: center; align-items: center;
            color: var(--accent-color); text-align: center; padding: 20px;
        }

        /* --- CUSTOM CURSOR --- */
        #cursor {
            position: fixed; top: 0; left: 0; width: var(--cursor-size); height: var(--cursor-size);
            border: 2px solid var(--accent-color); transform: translate(-50%, -50%) rotate(45deg);
            pointer-events: none; z-index: 9999; transition: width 0.1s, height 0.1s;
            mix-blend-mode: difference;
        }
        #cursor.active { background: var(--accent-color); width: 10px; height: 10px; }
        
        @media (hover: none) and (pointer: coarse) {
            #cursor { display: none; }
            * { cursor: auto !important; }
        }
        
        /* --- BACKGROUND FX --- */
        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYV/hXchAAAAHXRSTlMA+++++++++g+++++++O++++++f++++++U+++++f62T+fAAAAHlJREFUeNrtwQEBAAAAgqD+r2zHBxQAAAAAAAAAAAAAAIB3BuG1AAG35GzgAAAAAElFTkSuQmCC') repeat;
            opacity: 0.05; z-index: 900;
        }

        /* --- TICKER --- */
        .ticker-wrap {
            width: 100%; overflow: hidden; background-color: var(--accent-color);
            color: #000; border-bottom: 1px solid var(--grid-line);
        }
        .ticker {
            display: inline-block; white-space: nowrap; padding: 10px 0;
            animation: ticker 15s linear infinite; font-family: var(--font-mono);
            font-weight: 700; font-size: 1.2rem;
        }
        .ticker__item { padding: 0 2rem; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 40px; border-bottom: 1px solid var(--grid-line);
            position: sticky; top: 0; background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(5px); z-index: 100;
        }
        .logo-container img { 
            height: 40px; width: auto; display: block;
        }
        .nav-links { display: flex; gap: 40px; font-family: var(--font-mono); font-size: 0.85rem; }
        .nav-links li { transition: 0.2s; }
        .nav-links li:hover { color: var(--accent-color); text-shadow: 2px 0 var(--secondary-accent); }

        /* --- CONTROLS --- */
        .controls-panel {
            position: fixed; bottom: 30px; right: 30px; z-index: 800;
            display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
        }
        .control-btn {
            background: rgba(0,0,0,0.9); border: 1px solid #333; color: #fff;
            padding: 10px 15px; font-family: var(--font-mono); font-size: 0.8rem;
            transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .control-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .audio-group { display: flex; gap: 5px; background: #000; padding: 5px; border: 1px solid #333; }
        .active-music { background-color: var(--accent-color) !important; color: #000 !important; border-color: var(--accent-color) !important; }

        /* --- HERO --- */
        .hero { padding: 80px 40px; border-bottom: 1px solid var(--grid-line); position: relative; }
        .hero h1 {
            font-size: clamp(3rem, 8vw, 8rem); line-height: 0.85; font-weight: 800;
            letter-spacing: -3px; margin-bottom: 30px;
        }
        .glitch-text { display: inline-block; transition: 0.3s; }
        .hero:hover .glitch-text { color: var(--accent-color); transform: skewX(-10deg); }

        .cta-btn {
            padding: 15px 40px; background: transparent; border: 2px solid var(--text-color);
            color: var(--text-color); font-family: var(--font-mono); font-weight: 700;
            font-size: 1rem; position: relative; overflow: hidden; transition: 0.3s; margin-top: 20px;
        }
        .cta-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: var(--accent-color); transition: 0.4s; z-index: -1;
        }
        .cta-btn:hover::before { left: 0; }
        .cta-btn:hover { border-color: var(--accent-color); color: black; box-shadow: 0 0 20px var(--accent-color); }
        .cta-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- EVENTS --- */
        .events-container { border-bottom: 1px solid var(--grid-line); scroll-margin-top: 80px; }
        .filter-bar {
            display: flex; gap: 20px; padding: 20px 40px; border-bottom: 1px solid var(--grid-line);
            font-family: var(--font-mono); font-size: 0.9rem; overflow-x: auto; position: sticky; top: 80px; background: var(--bg-color); z-index: 90;
        }
        .filter-btn { opacity: 0.5; transition: 0.3s; cursor: none; }
        .filter-btn.active, .filter-btn:hover { opacity: 1; color: var(--accent-color); text-decoration: underline; }

        .event-row {
            display: grid; grid-template-columns: 1fr 3fr 1fr; padding: 25px 40px;
            border-bottom: 1px solid #1a1a1a; align-items: center; transition: 0.2s;
            scroll-margin-top: 140px; 
        }
        .event-row:hover { background: var(--text-color); color: var(--bg-color); }
        .event-row:hover .date { color: var(--bg-color); }
        .date { font-family: var(--font-mono); color: var(--accent-color); font-weight: 700; font-size: 1.5rem; }
        .ticket-tag { border: 1px solid currentColor; padding: 5px 15px; font-family: var(--font-mono); font-size: 0.8rem; }

        /* --- BIG LOGO SECTION --- */
        .big-logo-section {
            padding: 60px 0; border-bottom: 1px solid var(--grid-line);
            display: flex; justify-content: center; align-items: center; background: #000;
        }
        .big-logo-section a { display: block; width: 100%; text-align: center; }
        .big-logo-section img {
            max-width: 100%; width: 900px; height: auto; filter: none; transition: 0.3s;
        }
        .big-logo-section img:hover {
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1)); transform: scale(1.01);
        }

        /* --- FOOTER --- */
        footer {
            padding: 80px 40px; display: flex; flex-direction: column; justify-content: center;
            align-items: center; font-family: var(--font-mono); color: #666; font-size: 0.8rem;
            gap: 30px; text-align: center;
        }
        .footer-text { display: flex; flex-direction: column; gap: 10px; }
        .social-links { display: flex; gap: 30px; font-size: 1.8rem; }
        .social-links a { color: var(--accent-color); transition: 0.3s; }
        .social-links a:hover { color: #fff; text-shadow: 0 0 15px var(--accent-color); transform: scale(1.1); }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 9998; justify-content: center;
            align-items: center; flex-direction: column;
        }
        .newsletter-box {
            border: 2px solid var(--text-color); background: #000; padding: 40px;
            max-width: 500px; width: 90%; text-align: center; position: relative;
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.1); pointer-events: auto; 
        }
        .newsletter-input {
            width: 100%; padding: 15px; background: #111; border: 1px solid #333;
            color: white; font-family: var(--font-mono); margin: 20px 0; text-align: center;
        }
        .newsletter-input:focus { border-color: var(--accent-color); outline: none; }

        /* GAME UI FIXES */
        .game-wrapper {
            position: relative; border: 2px solid var(--accent-color);
            box-shadow: 0 0 50px rgba(255, 51, 51, 0.15);
            max-width: 100%;
            width: 800px;
        }
        canvas { display: block; background: #050505; cursor: crosshair; width: 100%; height: auto; }
        
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .close-modal { position: absolute; top: -40px; right: 0; font-family: var(--font-mono); color: #fff; cursor: none; font-size: 1rem; pointer-events: auto;}
        .close-modal:hover { color: var(--accent-color); }
        
        .in-game-mute {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            background: #333; border: 1px solid #555; color: #888;
            padding: 8px 15px; font-family: var(--font-mono); font-size: 0.8rem;
            z-index: 10002; transition: 0.3s;
        }
        .in-game-mute.active {
            background: var(--accent-color); border-color: var(--accent-color); color: #000; font-weight: bold;
        }

        /* --- HUD (DESKTOP) --- */
        #scoreHud {
            position: absolute; top: 20px; left: 20px; font-family: var(--font-mono);
            color: white; font-size: 1.2rem; display: none; text-shadow: 0 0 5px rgba(0,0,0,0.8);
            z-index: 100;
            background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; /* Background para contraste */
        }
        
        #livesHud {
            position: absolute; bottom: 20px; left: 20px; font-family: var(--font-mono);
            color: var(--accent-color); font-size: 1rem; display: none; z-index: 100;
            background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px;
        }
        
        #mobileControlsHint {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            font-family: var(--font-mono); color: rgba(255,255,255,0.4); font-size: 0.7rem;
            pointer-events: none; display: none;
        }

        @media(max-width: 768px) {
            .hero h1 { font-size: 3.5rem; }
            .nav-links { display: none; }
            .controls-panel { bottom: 10px; right: 10px; }
            
            /* FIX JUEGO MOVIL: Asegurar que cabe en pantalla con márgenes */
            .game-wrapper { width: 95vw; max-width: 95vw; margin: 0 auto; box-sizing: border-box; border-width: 1px; }
            
            /* FIX NEWSLETTER MOVIL: Más pequeña y manejable */
            .newsletter-box { width: 90%; padding: 25px; margin: 0 auto; }
            
            #mobileControlsHint { display: block; bottom: 10px; font-size: 0.65rem; }

            /* --- HUD MÓVIL (REDISTRIBUIDO) --- */
            #scoreHud {
                top: 10px; left: 10px; font-size: 0.9rem; /* Arriba Izquierda */
                text-shadow: 1px 1px 2px black;
                padding: 3px 8px;
            }
            #livesHud {
                bottom: auto; top: 10px; left: auto; right: 10px; /* Arriba Derecha (Lejos de pulgares) */
                font-size: 0.8rem;
                padding: 3px 8px;
            }
        }
    </style>
</head>
<body>

    <div id="cursor"></div>
    <div class="noise-overlay"></div>

    <!-- ROTATE OVERLAY (Ahora controlado por JS al iniciar juego) -->
    <div id="rotateOverlay">
        <i class="fas fa-rotate" style="font-size: 4rem; margin-bottom: 20px;"></i>
        <h2 style="font-size: 1.5rem;">GIRA TU TELÉFONO</h2>
        <p style="font-family: var(--font-mono); margin-top: 10px;">GIRA LA PANTALLA PARA INICIAR LA MISIÓN.</p>
    </div>

    <!-- CONTROLES -->
    <div class="controls-panel">
        <div class="audio-group">
            <button class="control-btn hover-target" onclick="toggleMusic()" id="playBtn">
                <i class="fas fa-play"></i>
            </button>
            <button class="control-btn hover-target" onclick="changeTrack()">
                <i class="fas fa-forward"></i>
            </button>
            <div class="control-btn" style="border:none; color:#888;" id="trackDisplay">TRACK 1</div>
        </div>
    </div>

    <!-- MARQUESINA -->
    <div class="ticker-wrap">
        <div class="ticker">
            <span class="ticker__item">LA SEÑAL LLEGA A LATAM</span>
            <span class="ticker__item">COLOMBIA • MÉXICO • ARGENTINA • CHILE</span>
            <span class="ticker__item">/// XINA MORA LIVE</span>
            <span class="ticker__item">INDUSTRIAL TECHNO EXPERIENCE</span>
            <span class="ticker__item">GET YOUR TICKETS NOW</span>
        </div>
    </div>

    <header>
        <div class="logo-container hover-target">
            <img src="logo.png" alt="XINA MORA LOGO" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <h2 style="font-weight:800; letter-spacing:-1px; display:none;">XINA MORA</h2>
        </div>
        <ul class="nav-links">
            <li class="hover-target" onclick="document.querySelector('.events-container').scrollIntoView({behavior: 'smooth'})">TOUR</li>
            <li class="hover-target" onclick="window.open('https://open.spotify.com/intl-es/artist/4dRPdWRUFyJp0yhjGBLClx', '_blank')">MÚSICA</li>
            <li class="hover-target" onclick="openGame()">JUEGO</li>
            <li class="hover-target" onclick="window.open('https://shop.xinamora.com', '_blank')">MERCH</li>
        </ul>
    </header>

    <section class="hero">
        <h1>
            <span class="glitch-text">LA SEÑAL</span><br>
            LLEGA A <span style="color:var(--accent-color)">LATAM</span>
        </h1>
        <p style="font-family: var(--font-mono); max-width: 500px; margin-bottom: 30px;">
            EL TOUR TECHNO MÁS ESPERADO. RECIBE LA SEÑAL.
        </p>
        <button class="cta-btn hover-target" onclick="openGame()">
            [ INICIAR MISIÓN: JUGAR PARA GANAR ]
        </button>
    </section>

    <section class="events-container">
        <div class="filter-bar">
            <span class="filter-btn active hover-target" onclick="scrollToEvent('all')">TODAS LAS FECHAS</span>
            <span class="filter-btn hover-target" onclick="scrollToEvent('col')">COLOMBIA</span>
            <span class="filter-btn hover-target" onclick="scrollToEvent('mex')">MÉXICO</span>
            <span class="filter-btn hover-target" onclick="scrollToEvent('arg')">ARGENTINA</span>
            <span class="filter-btn hover-target" onclick="scrollToEvent('chi')">CHILE</span>
        </div>

        <div class="event-row hover-target" id="event-col">
            <div class="date">28.11</div>
            <div class="details">
                <h3>BOGOTÁ</h3>
                <p>GATE CLUB // COLOMBIA</p>
            </div>
            <div class="action"><span class="ticket-tag">TICKETS</span></div>
        </div>
        <div class="event-row hover-target" id="event-mex">
            <div class="date">29.11</div>
            <div class="details">
                <h3>CDMX</h3>
                <p>TBA // MÉXICO</p>
            </div>
            <div class="action"><span class="ticket-tag">TICKETS</span></div>
        </div>
        
        <div class="event-row hover-target" id="event-arg" onclick="window.open('https://www.passline.com/eventos/xina-mora-en-argentina-5-de-diciembre', '_blank')" style="cursor: pointer;">
            <div class="date">05.12</div>
            <div class="details">
                <h3>BUENOS AIRES</h3>
                <p>TBA // ARGENTINA</p>
            </div>
            <div class="action"><span class="ticket-tag">TICKETS</span></div>
        </div>

        <div class="event-row hover-target" id="event-chi">
            <div class="date">07.12</div>
            <div class="details">
                <h3>SANTIAGO</h3>
                <p>TBA // CHILE</p>
            </div>
            <div class="action"><span class="ticket-tag">TICKETS</span></div>
        </div>
    </section>

    <div class="big-logo-section hover-target">
        <a href="https://www.xinamora.com" target="_blank" class="hover-target">
            <img src="logo.png" alt="XINA MORA LARGE LOGO" onerror="this.style.display='none'">
        </a>
    </div>

    <footer>
        <div class="footer-text">
            <span>© 2025 XINA MORA ENTERTAINMENT</span>
            <span>DISEÑADO PARA EL UNDERGROUND</span>
        </div>
        <div class="social-links">
            <a href="https://www.instagram.com/laxinamora/?hl=es" target="_blank" class="hover-target"><i class="fab fa-instagram"></i></a>
            <a href="https://www.tiktok.com/@laxinamora?lang=es" target="_blank" class="hover-target"><i class="fab fa-tiktok"></i></a>
            <a href="https://www.youtube.com/@XinaMora" target="_blank" class="hover-target"><i class="fab fa-youtube"></i></a>
            <a href="https://open.spotify.com/intl-es/artist/4dRPdWRUFyJp0yhjGBLClx" target="_blank" class="hover-target"><i class="fab fa-spotify"></i></a>
        </div>
    </footer>

    <!-- MODALS -->
    <div id="newsletterModal" class="modal-overlay">
        <div class="newsletter-box">
            <div class="close-modal hover-target" onclick="closeNewsletter()" style="top:10px; right:20px; font-size:1.5rem;">✕</div>
            <h2>RECIBE LA SEÑAL</h2>
            <p style="margin-top:10px; font-family:var(--font-mono); color:#888;">INFO EXCLUSIVA DEL TOUR.</p>
            
            <form id="newsletterForm" action="https://formspree.io/f/mnnrbgwb" method="POST">
                <input type="email" name="_replyto" class="newsletter-input hover-target" placeholder="EMAIL_ADDRESS" required>
                <input type="hidden" name="Subject" value="Suscripción XINA MORA Newsletter">
                <button type="submit" id="newsletterBtn" class="cta-btn hover-target">SUSCRIBIRSE</button>
            </form>
            <p id="newsletterStatus" style="font-family: var(--font-mono); font-size: 0.8rem; color: #fff; margin-top: 10px; min-height: 1.2em;"></p>
        </div>
    </div>

    <!-- MODAL JUEGO -->
    <div id="gameModal" class="modal-overlay">
        <div class="game-wrapper">
            <div class="close-modal hover-target" onclick="closeGame()">✕ SALIR</div>
            
            <button class="in-game-mute hover-target" onclick="toggleMusic()" id="inGameMuteBtn">
                <i class="fas fa-volume-mute"></i> MUSIC: OFF
            </button>

            <canvas id="gameCanvas" width="800" height="500"></canvas>
            
            <div id="scoreHud"></div>
            <div id="livesHud"></div>
            <!-- INSTRUCCIONES ACTUALIZADAS -->
            <div id="mobileControlsHint">IZQUIERDA: MOVER NAVES /// DERECHA: DISPARAR</div>

            <div id="uiLayer" class="ui-layer">
                <!-- Game Over -->
                <div id="gameOverScreen" class="newsletter-box" style="display:none; border-color:var(--accent-color);">
                    <h2 style="color: var(--accent-color); text-shadow: 0 0 10px red;">HAS MUERTO</h2>
                    <p style="margin: 10px 0; font-family: var(--font-mono);">LA SEÑAL SE HA PERDIDO.</p>
                    <p style="font-size: 0.8rem; color:#666; margin-bottom: 20px;">ENVÍA INFORME DE ERROR PARA SALIR.</p>
                    
                    <form id="exitForm" action="https://formspree.io/f/mnnrbgwb" method="POST">
                        <input type="email" id="exitEmail" name="_replyto" class="newsletter-input hover-target" placeholder="TU_EMAIL" required>
                        <input type="hidden" name="Subject" value="Informe de Error XINA MORA - Juego">
                        <input type="hidden" name="Game_Score" id="hiddenScoreInput">
                        <button type="submit" id="sendExitBtn" class="cta-btn hover-target">ENVIAR LA SEÑAL</button>
                    </form>

                    <p id="exitStatus" style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--secondary-accent); margin-top: 10px; min-height: 1.2em;"></p>
                    
                    <div style="margin-top: 20px;">
                        <span class="hover-target" onclick="startGame()" style="font-size: 0.8rem; text-decoration: underline; cursor: none; color: #fff;">REINTENTAR MISIÓN</span>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-top: 15px; font-family: var(--font-mono); color: #666; font-size: 0.8rem;" id="controlsText">
            /// SYSTEM READY
        </div>
    </div>

    <script>
        // --- CORE FUNCTIONS ---
        const formspreeUrl = 'https://formspree.io/f/mnnrbgwb';

        function scrollToEvent(id) {
            if(id === 'all') {
                window.scrollTo({top: 0, behavior: 'smooth'});
            } else {
                const el = document.getElementById('event-' + id);
                if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        }

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol = 0.1) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            if(type === 'sawtooth') osc.frequency.exponentialRampToValueAtTime(freq * 0.1, audioCtx.currentTime + duration);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function sfxShoot() { playTone(800, 'sawtooth', 0.1, 0.05); }
        function sfxHit() { playTone(150, 'square', 0.2, 0.2); }
        function sfxExplosion() { playTone(100, 'square', 0.4, 0.3); playTone(50, 'sawtooth', 0.5, 0.3); }

        // --- MUSIC ---
        const tracks = [{ name: "TRACK 1", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }];
        let audio = new Audio(tracks[0].src);
        audio.volume = 0.6; audio.loop = true;

        function updateMusicUI(isPlaying) {
            const mainBtn = document.getElementById('playBtn');
            const gameBtn = document.getElementById('inGameMuteBtn');
            if(isPlaying) {
                mainBtn.classList.add('active-music'); mainBtn.innerHTML = '<i class="fas fa-pause"></i>';
                gameBtn.classList.add('active'); gameBtn.innerHTML = '<i class="fas fa-volume-up"></i> MUSIC: ON';
            } else {
                mainBtn.classList.remove('active-music'); mainBtn.innerHTML = '<i class="fas fa-play"></i>';
                gameBtn.classList.remove('active'); gameBtn.innerHTML = '<i class="fas fa-volume-mute"></i> MUSIC: OFF';
            }
        }
        function toggleMusic() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if(audio.paused) { audio.play(); updateMusicUI(true); } 
            else { audio.pause(); updateMusicUI(false); }
        }
        function changeTrack() { audio.currentTime = 0; if(audio.paused) toggleMusic(); }

        // --- FORMS ---
        async function handleExitFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('sendExitBtn');
            const status = document.getElementById('exitStatus');
            document.getElementById('hiddenScoreInput').value = `Score: ${score}`;
            btn.disabled = true; btn.innerText = "CONECTANDO...";
            status.innerHTML = `ENVIANDO...`; status.style.color = "#33ff33";
            try {
                const response = await fetch(form.action, { method: form.method, body: new FormData(form), headers: { 'Accept': 'application/json' } });
                if (response.ok) {
                    status.innerHTML = "SEÑAL VERIFICADA.";
                    setTimeout(() => { closeGame(); form.reset(); status.innerHTML = ""; }, 2000);
                } else { status.innerHTML = "ERROR."; status.style.color = "red"; }
            } catch { status.innerHTML = "ERROR DE CONEXIÓN."; status.style.color = "red"; } 
            finally { btn.disabled = false; btn.innerText = "ENVIAR LA SEÑAL"; }
        }

        async function handleNewsletterSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('newsletterBtn');
            const status = document.getElementById('newsletterStatus');
            btn.disabled = true; btn.innerText = "VERIFICANDO...";
            try {
                const response = await fetch(form.action, { method: form.method, body: new FormData(form), headers: { 'Accept': 'application/json' } });
                if (response.ok) {
                    status.innerHTML = "¡GRACIAS! Ya estás en la lista."; status.style.color = "#33ff33";
                    setTimeout(() => { closeNewsletter(); form.reset(); status.innerHTML = ""; }, 2000);
                } else { status.innerHTML = "ERROR."; status.style.color = "red"; }
            } catch { status.innerHTML = "ERROR DE CONEXIÓN."; status.style.color = "red"; } 
            finally { btn.disabled = false; btn.innerText = "SUSCRIBIRSE"; }
        }

        setTimeout(() => { document.getElementById('newsletterModal').style.display = 'flex'; }, 15000);
        function closeNewsletter() { document.getElementById('newsletterModal').style.display = 'none'; }

        // --- CURSOR ---
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => { cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px'; });
        document.querySelectorAll('.hover-target').forEach(el => {
            el.addEventListener('mouseenter', () => { cursor.classList.add('active'); document.body.style.cursor = 'none'; });
            el.addEventListener('mouseleave', () => cursor.classList.remove('active'));
        });

        window.addEventListener('load', () => {
            const exitForm = document.getElementById('exitForm');
            const newsletterForm = document.getElementById('newsletterForm');
            if (exitForm) exitForm.addEventListener('submit', handleExitFormSubmit);
            if (newsletterForm) newsletterForm.addEventListener('submit', handleNewsletterSubmit);
        });

        // ==========================================
        // === GAME ENGINE V14: VISUAL TWEAKS ===
        // ==========================================
        const modal = document.getElementById('gameModal');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const rotateOverlay = document.getElementById('rotateOverlay');
        
        let gameLoopId = null;
        let gameActive = false;
        let gameRequested = false; // Nuevo estado: ¿El usuario quiere jugar?
        let score = 0;
        let shake = 0;
        let hitFlash = 0;
        
        // Input State
        const keys = {};
        // Reset inputs on start
        let touchInput = { active: false, y: 250, fire: false };
        let player = { x: 50, y: 250, spd: 5, cd: 0, hp: 3, maxHp: 3 };

        // Desktop Inputs
        document.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='Space'||e.code.startsWith('Arrow')) e.preventDefault(); });
        document.addEventListener('keyup', e => delete keys[e.code]);
        
        // --- MOBILE INPUTS ---
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchInput.active = true;
            updateTouch(e.touches);
        }, {passive: false});
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            updateTouch(e.touches);
        }, {passive: false});
        
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            if(e.touches.length === 0) {
                touchInput.active = false;
                touchInput.fire = false;
            } else {
                updateTouch(e.touches);
            }
        });

        function updateTouch(touches) {
            touchInput.fire = false;
            let leftTouchFound = false;
            
            for(let i=0; i<touches.length; i++) {
                const t = touches[i];
                const rect = canvas.getBoundingClientRect();
                const tX = (t.clientX - rect.left) * (canvas.width / rect.width);
                const tY = (t.clientY - rect.top) * (canvas.height / rect.height);
                
                if(tX > canvas.width / 2) {
                    touchInput.fire = true;
                } else {
                    touchInput.y = tY;
                    leftTouchFound = true;
                }
            }
        }

        // --- GESTIÓN DE ORIENTACIÓN Y JUEGO ---
        function checkGameOrientation() {
            // Si el juego ha sido solicitado
            if (gameRequested) {
                // Si es pantalla pequeña y vertical
                if (window.innerWidth < 900 && window.innerHeight > window.innerWidth) {
                    rotateOverlay.style.display = 'flex'; // Muestra "GIRA"
                    modal.style.display = 'none'; // Oculta el juego momentáneamente
                    if (gameActive) {
                        gameActive = false; // Pausa lógica si estaba corriendo
                        if(gameLoopId) cancelAnimationFrame(gameLoopId);
                    }
                } else {
                    // Es horizontal o escritorio
                    rotateOverlay.style.display = 'none'; // Oculta "GIRA"
                    modal.style.display = 'flex'; // Muestra juego
                    if (!gameActive) {
                        startGame(); // Inicia (o reanuda)
                    }
                }
            } else {
                // Si no se ha pedido el juego, asegurar que overlay esté oculto
                rotateOverlay.style.display = 'none';
            }
        }

        // Escuchar cambios de tamaño/orientación
        window.addEventListener('resize', checkGameOrientation);

        function openGame() {
            gameRequested = true; // Activa la intención de jugar
            document.body.style.overflow = 'hidden';
            checkGameOrientation(); // Verifica inmediatamente
        }

        function closeGame() {
            gameRequested = false; // Cancela intención
            modal.style.display = 'none';
            rotateOverlay.style.display = 'none';
            document.body.style.overflow = 'auto';
            gameActive = false;
            if(gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoopId = null;
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('scoreHud').style.display = 'none';
            document.getElementById('livesHud').style.display = 'none';
        }

        // Entities & Background
        let entities = [];
        let particles = [];
        let stars = [];

        function initStars() {
            stars = [];
            for(let i=0; i<100; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 0.5,
                    spd: Math.random() * 3 + 0.5,
                    alpha: Math.random()
                });
            }
        }

        function startGame() {
            gameActive = false;
            if(gameLoopId) cancelAnimationFrame(gameLoopId);
            
            touchInput = { active: false, y: 250, fire: false };
            score = 0;
            shake = 0;
            hitFlash = 0;
            player = { x: 50, y: 250, w: 30, h: 20, spd: 8, cd: 0, hp: 3, maxHp: 3 }; 
            entities = [];
            particles = [];
            initStars();
            
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('uiLayer').style.pointerEvents = 'none';
            document.getElementById('scoreHud').style.display = 'block';
            document.getElementById('livesHud').style.display = 'block';
            
            gameActive = true;
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameActive = false;
            sfxExplosion();
            document.getElementById('uiLayer').style.pointerEvents = 'auto';
            document.getElementById('gameOverScreen').style.display = 'block';
        }

        function spawnExplosion(x, y, color) {
            for(let i=0; i<15; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 1.0, color, size: Math.random()*3+1
                });
            }
        }

        function drawPolygon(ctx, x, y, radius, sides, color, rotation=0) {
            ctx.beginPath();
            for (let i = 0; i < sides; i++) {
                const angle = rotation + (i * 2 * Math.PI / sides);
                ctx.lineTo(x + radius * Math.cos(angle), y + radius * Math.sin(angle));
            }
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = color;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function gameLoop() {
            if(!gameActive) return;

            // Background & Shake
            ctx.fillStyle = '#050505';
            ctx.save();
            
            if(shake > 0) {
                const dx = (Math.random()-0.5)*shake;
                const dy = (Math.random()-0.5)*shake;
                ctx.translate(dx, dy);
                shake *= 0.9;
                if(shake < 0.5) shake = 0;
            }
            
            ctx.fillRect(0,0, canvas.width, canvas.height);

            // Draw Stars
            ctx.fillStyle = '#fff';
            stars.forEach(s => {
                s.x -= s.spd;
                if(s.x < 0) s.x = canvas.width;
                ctx.globalAlpha = s.alpha;
                ctx.fillRect(s.x, s.y, s.size, s.size);
            });
            ctx.globalAlpha = 1;

            // Update UI
            document.getElementById('scoreHud').innerText = `SCORE: ${score}`;
            document.getElementById('livesHud').innerHTML = `INTEGRITY: ${'█'.repeat(player.hp)}<span style="opacity:0.3">${'█'.repeat(player.maxHp - player.hp)}</span>`;

            // Player Logic
            if (touchInput.active) {
                const dy = touchInput.y - player.y;
                if (Math.abs(dy) > 5) {
                    player.y += dy * 0.15; // Smooth factor
                }
            } else {
                if(keys['ArrowUp']) player.y -= player.spd;
                if(keys['ArrowDown']) player.y += player.spd;
            }
            
            player.y = Math.max(20, Math.min(canvas.height-20, player.y));

            // Draw Player
            ctx.save();
            ctx.translate(player.x, player.y);
            
            // Engine Trail
            if(Math.random() > 0.5) {
                particles.push({
                    x: player.x - 10, y: player.y + (Math.random()-0.5)*5,
                    vx: -4, vy: 0, life: 0.5, color: 'cyan', size: 2
                });
            }

            // Hit Flash
            if(hitFlash > 0) {
                ctx.globalCompositeOperation = 'source-over';
                ctx.fillStyle = `rgba(255, 0, 0, ${hitFlash})`;
                hitFlash -= 0.1;
            } else {
                ctx.fillStyle = '#000';
            }

            // Ship Body
            ctx.strokeStyle = 'cyan';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'cyan';
            ctx.beginPath();
            ctx.moveTo(20, 0);
            ctx.lineTo(-15, -10);
            ctx.lineTo(-10, 0);
            ctx.lineTo(-15, 10);
            ctx.closePath();
            ctx.stroke();
            if(hitFlash > 0) ctx.fill();

            ctx.restore();

            // Shooting
            if(player.cd > 0) player.cd--;
            if((keys['Space'] || touchInput.fire) && player.cd <= 0) {
                entities.push({ type: 'bullet', x: player.x+20, y: player.y, w: 15, h: 3, vx: 12, color: '#33ff33' });
                sfxShoot();
                player.cd = 8;
            }

            // Spawn Enemies
            if(Math.random() < 0.02 + (score/10000)) {
                entities.push({ 
                    type: 'enemy', x: canvas.width + 50, y: Math.random()*(canvas.height-40)+20, 
                    radius: 15, vx: -(4 + Math.random()*4), color: '#ff3333'
                });
            }

            // Process Entities
            for(let i = entities.length-1; i>=0; i--) {
                let e = entities[i];
                e.x += e.vx;
                
                if(e.type === 'bullet') {
                    ctx.fillStyle = e.color;
                    ctx.shadowBlur = 10; ctx.shadowColor = e.color;
                    ctx.fillRect(e.x, e.y-1, e.w, e.h);
                    ctx.shadowBlur = 0;
                    if(e.x > canvas.width) entities.splice(i, 1);
                } 
                else if(e.type === 'enemy') {
                    e.angle = (e.angle || 0) + 0.1;
                    drawPolygon(ctx, e.x, e.y, e.radius, 4, e.color, e.angle);

                    // Collision with Player
                    if(Math.hypot(e.x - player.x, e.y - player.y) < e.radius + 15) {
                        player.hp--;
                        entities.splice(i, 1);
                        shake = 20; // Big Shake
                        hitFlash = 1.0;
                        sfxHit();
                        spawnExplosion(player.x, player.y, 'red');
                        if(player.hp <= 0) gameOver();
                    }
                    else if(e.x < -50) entities.splice(i, 1);
                }

                // Bullet vs Enemy
                if(e.type === 'bullet') {
                    for(let j=0; j<entities.length; j++) {
                        let t = entities[j];
                        if(t.type === 'enemy' && Math.hypot(e.x - t.x, e.y - t.y) < t.radius + 5) {
                            spawnExplosion(t.x, t.y, '#ffaa00');
                            sfxExplosion();
                            entities.splice(j, 1); // Remove enemy
                            entities.splice(i, 1); // Remove bullet
                            score += 100;
                            break;
                        }
                    }
                }
            }

            // Draw Particles
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.03;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
                if(p.life <= 0) particles.splice(i, 1);
            });
            ctx.globalAlpha = 1;

            ctx.restore();
            gameLoopId = requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
